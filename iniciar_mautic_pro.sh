#!/bin/bash

# Mostrar encabezado con logo
echo -e "\e[32m"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
echo "â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘"
echo "â•šâ•â•â•â•â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘"
echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•"
echo "â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• "
echo -e "\e[0m"
echo -e "\e[1;33mðŸš€ Plataforma de AutomatizaciÃ³n - SystemBlack\e[0m"
echo "" ""

echo "=== CONFIGURACIÃ“N INICIAL DE MAUTIC + TRAEFIK ==="

read -p "ðŸ”Ž Dominio principal para Mautic (ej: mautic.midominio.com): " MAUTIC_DOMAIN
read -p "ðŸ”Ž Dominio para PhpMyAdmin (ej: pma.midominio.com): " PMA_DOMAIN
read -p "ðŸ”Ž Correo electrÃ³nico para Let's Encrypt: " EMAIL
read -p "ðŸ”Ž Nombre de la base de datos para Mautic: " DB_NAME
read -p "ðŸ”Ž Usuario de la base de datos: " DB_USER
read -p "ðŸ”Ž ContraseÃ±a de la base de datos: " DB_PASS

# ConfirmaciÃ³n de los datos
clear
echo -e "\nðŸ” Verifica que los siguientes datos sean correctos:\n"
echo "Dominio Mautic      : $MAUTIC_DOMAIN"
echo "Dominio PhpMyAdmin  : $PMA_DOMAIN"
echo "Correo ElectrÃ³nico  : $EMAIL"
echo "DB Nombre           : $DB_NAME"
echo "DB Usuario          : $DB_USER"
echo "DB ContraseÃ±a        : $DB_PASS"
echo ""
read -p "âœ… Â¿Son correctos estos datos? (s/n): " confirm

if [[ "$confirm" != "s" && "$confirm" != "S" ]]; then
  echo "âŒ OperaciÃ³n cancelada reiniciando."
    sleep 2
    clear
    sleep 2
   ./iniciar_mautic.sh
 
fi



echo "âœ… Generando docker-compose.yml..."

cat > docker-compose.yml <<EOF
version: '3.3'

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=${EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./letsencrypt:/letsencrypt
    networks:
      - mautic-traefik_mautic_net

  mautic:
    image: mautic/mautic:latest
    container_name: mautic
    restart: always
    volumes:
      - mautic_data:/var/www/html
    environment:
      - MAUTIC_DB_HOST=db
      - MAUTIC_DB_PORT=3306
      - MAUTIC_DB_NAME=${DB_NAME}
      - MAUTIC_DB_USER=${DB_USER}
      - MAUTIC_DB_PASSWORD=${DB_PASS}

      - MAUTIC_RUN_CRON_JOBS=true
    depends_on:
      - db
    networks:
      - mautic-traefik_mautic_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mautic.rule=Host(\`${MAUTIC_DOMAIN}\`)"
      - "traefik.http.routers.mautic.entrypoints=websecure"
      - "traefik.http.routers.mautic.tls=true"
      - "traefik.http.routers.mautic.tls.certresolver=myresolver"
      - "traefik.http.services.mautic.loadbalancer.server.port=80"

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: pma_mautic
    restart: always
    environment:
      PMA_HOST: db
      MYSQL_ROOT_PASSWORD: rootpass
    depends_on:
      - db
    networks:
      - mautic-traefik_mautic_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pma.rule=Host(\`${PMA_DOMAIN}\`)"
      - "traefik.http.routers.pma.entrypoints=websecure"
      - "traefik.http.routers.pma.tls=true"
      - "traefik.http.routers.pma.tls.certresolver=myresolver"
      - "traefik.http.services.pma.loadbalancer.server.port=80"

  db:
    image: mariadb:10.6
    container_name: mautic_db
    restart: always
    volumes:
      - db_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_DATABASE=mautic
      - MYSQL_USER=mauticuser
      - MYSQL_PASSWORD=mauticpass
    networks:
      - mautic-traefik_mautic_net

volumes:
  mautic_data:
  db_data:

networks:
  mautic-traefik_mautic_net:
    external: true
EOF

echo "âœ… Preparando letsencrypt/acme.json..."
mkdir -p letsencrypt
rm -f letsencrypt/acme.json
touch letsencrypt/acme.json
chmod 600 letsencrypt/acme.json

echo "ðŸš€ Iniciando contenedores con Docker Compose..."
docker compose up -d

echo
echo "ðŸŽ¯ Accede a Mautic en: https://${MAUTIC_DOMAIN}"
echo "ðŸŽ¯ Accede a PhpMyAdmin en: https://${PMA_DOMAIN}"

echo

echo "âœ… Finalizando la Instalacion..."
sleep 2
rm -f iniciar_mautic.sh


echo "ðŸš€ Datos de la base de datos de Mautic.."

echo "âœ… Nombre Base de Datos: ${DB_NAME}"
echo "âœ… Nombre Base de Usuario: ${DB_USER}"
echo "âœ… Nombre Base de ContraseÃ±a: ${DB_PASS}"


 





